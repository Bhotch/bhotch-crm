<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Ultimate Lomanco CRM Automation System - Enterprise-grade automation for roofing vent calculations"
    />
    <meta name="keywords" content="CRM, Lomanco, roofing, vent calculator, automation, enterprise" />
    <meta name="author" content="Ultimate CRM Team" />
    <meta name="robots" content="index, follow" />

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/favicon.ico" />

    <!-- Manifest for PWA -->
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />

    <!-- PWA meta tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="bhotch-crm">

    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileColor" content="#3b82f6">
    <meta name="msapplication-config" content="%PUBLIC_URL%/browserconfig.xml">

    <title>bhotch-crm</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>

    <!-- Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
              // Service worker registered successfully (silent)

              // Check for updates
              registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    // New content available
                    if (confirm('New version available! Refresh to update?')) {
                      window.location.reload();
                    }
                  }
                });
              });
            })
            .catch((registrationError) => {
              console.error('SW registration failed: ', registrationError);
            });
        });

        // Handle messages from service worker
        navigator.serviceWorker.addEventListener('message', (event) => {
          if (event.data && event.data.type === 'UPDATE_AVAILABLE') {
            if (confirm('App update available! Refresh to get the latest version?')) {
              window.location.reload();
            }
          }
        });
      }

      // PWA Install prompt
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;

        // Show install button or banner
        const installBtn = document.querySelector('#install-btn');
        if (installBtn) {
          installBtn.style.display = 'block';
          installBtn.addEventListener('click', () => {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
              // Install prompt accepted/declined (silent)
              deferredPrompt = null;
            });
          });
        }
      });

      // Detect if app is installed
      window.addEventListener('appinstalled', (evt) => {
        // App installed successfully (silent)
      });

      // Suppress browser extension async listener errors (Grammarly, LastPass, etc.)
      window.addEventListener('unhandledrejection', (event) => {
        // Check if it's a browser extension error
        if (event.reason &&
            event.reason.message &&
            event.reason.message.includes('message channel closed before a response was received')) {
          // Suppress this error - it's from browser extensions, not our code
          event.preventDefault();
          return;
        }

        // Check if it's a CORS error from Google Apps Script (expected)
        if (event.reason &&
            event.reason.message &&
            (event.reason.message.includes('CORS') || event.reason.message.includes('script.google.com'))) {
          // Suppress CORS errors - handled by the app
          event.preventDefault();
          return;
        }
      });
    </script>
  </body>
</html>
